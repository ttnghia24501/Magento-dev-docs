# Demonstrate ability to use EAV model concepts

## Describe the EAV hierarchy structure

EAV (Entity-attribute-value) is a model for storing entity attribute values in a certain storage place. For storage, 
Magento 2 supports MySQL-compatible databases (like MySQL, MySQL NDB Cluster, MariaDB, Percona, and others).

The table of the classic EAV model has 3 columns:

1. entity (object to which the attribute value must be set)
2. attribute
3. value

In the Flat model, attribute values are stored in the same table as the entities; a separate column is created 
for each attribute in the table.

In the EAV model, attribute values are stored in a separate table. A separate column is not created for each attribute,
and a new row is created for each attribute value of an entity in the EAV table.

## How EAV data storage works in Magento?

#### Magento receives entity attribute values as one large SQL query, which is generated by the following algorithm:

1. Get all attribute tables for a specific entity_type
2. For each table, do the following:
    - a select subquery is created from the current table, which requests value and attribute_id
    - the condition is added that entity_id = ID of the requested entity *
    - a condition is added for each scope that store_id IN ($ scope-> getValue ()) **
    - sorted by store_id in a descending order

3. UNION ALL of all subqueries is performed.

_* the field is not necessarily called entity_id. Magento uses $metadata->getLinkField() to get the field name._

_** the field is not necessarily called store_id. Magento uses $scope->getIdentifier() to get the field name._

#### What happens when a new attribute is added to the system

When a new attribute is added, new records are created in the database. Similar records are created for each attribute type.

#### How are attributes presented in the admin?

Below are some standard attribute types.

1. Text Field
2. Text Area
3. Text Editor
4. Page Builder
5. Date
6. Date and Time
7. Yes/No
8. Multiple Select
9. Dropdown
10. Price
11. Media Image
12. Fixed Product Tax
13. Visual Swatch
14. Text Swatch

#### How do you create customizations based on changes to attribute values?

To customize an attribute, modify the following attribute features:

- backend_model
- source_model
- attribute_model
- frontend_model

**Attribute Model**

The model allows to perform a more sophisticated attribute setting. By default, Magento\Eav\Model\Entity\Attribute is used, 
and a model, different from the default one, is rarely applied.

**Backend Model**

The model is used for processing and validating the attribute values.

By default, Magento\Eav\Model\Entity\Attribute\Backend\DefaultBackend is used.

It allows to define:

- validate
- afterLoad
- beforeSave
- afterSave
- beforeDelete
- afterDelete
- and other

Example:

```php
class TestBackend extends \Magento\Eav\Model\Entity\Attribute\Backend\AbstractBackend
{
    public function validate($object)
    {
        $attribute_code = $this->getAttribute()->getAttributeCode();
        $value = $object->getData($attribute_code);
        
        if ($value == 'test') {
            throw new \Magento\Framework\Exception\LocalizedException(__("Value can't be test"));
        }
        
        return true;
    }
 }
````

**Source Model**

The model is used for providing the list of the attribute values.

By default, Magento\Eav\Model\Entity\Attribute\Source\Config is used.

```php
class TestSource extends \Magento\Eav\Model\Entity\Attribute\Source\AbstractSource
{
    public function getAllOptions()
    {
        if (!$this->_options) {
            $this->_options = [
                ['label' => __('Label 1'), 'value' => 'value 1'],
                ['label' => __('Label 2'), 'value' => 'value 2'],
                ['label' => __('Label 3'), 'value' => 'value 3'],
                ['label' => __('Label 4'), 'value' => 'value 4']
            ];
        }
        return $this->_options;
    }
}
````
**Frontend Model**
Frontend model is used for displaying frontend part of the website.
By default, Magento\Eav\Model\Entity\Attribute\Frontend\DefaultFrontend is applied.
Example:

```php
class TestFrontend extends \Magento\Eav\Model\Entity\Attribute\Frontend\AbstractFrontend
{
    public function getValue(\Magento\Framework\DataObject $object)
    {
        $attribute_code = $this->getAttribute()->getAttributeCode();
        $value = $object->getData($attribute_code);
        return nl2br(htmlspecialchars($value));
    }
}
````