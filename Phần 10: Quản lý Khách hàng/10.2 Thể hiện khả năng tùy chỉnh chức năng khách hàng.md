# Demonstrate ability to customize customer functionality

## Describe how to add or modify customer attributes
To create a new customer attribute, use setup scripts. This is the example of customer attribute creation:

Describe how to extend the customer entity.
```php
class InstallData implements \Magento\Framework\Setup\InstallDataInterface
{
    private $customerSetupFactory;
    private $attributeSetFactory;
    public function __construct(
\Magento\Customer\Setup\CustomerSetupFactory $customerSetupFactory, 
\Magento\Eav\Model\Entity\Attribute\SetFactory $attributeSetFactory
)    {
        $this->customerSetupFactory = $customerSetupFactory;
        $this->attributeSetFactory = $attributeSetFactory;
    }

    public function install(
\Magento\Framework\Setup\ModuleDataSetupInterface $setup, \Magento\Framework\Setup\ModuleContextInterface $context
)    {
        $installer = $setup;
        $installer->startSetup();
        $customerSetup = $this->customerSetupFactory->create(['setup' => $setup]);
  $customerSetup->addAttribute(\Magento\Customer\Model\Customer::ENTITY, 'new_attribute', [
            'type' => 'varchar',
            'label' => 'new attribute',
            'input' => 'text',
            'required' => false,
            'visible' => true,
            'user_defined' => true,
            'system' => false,
                'used_in_forms' => [
                    'adminhtml_customer',
                    'adminhtml_checkout',
                    'checkout_register',
                    'customer_account_create',
                    'customer_account_edit',
                ]
            ]);
     }
````
Customer attributes can be displayed in different forms, which are set in used_in_forms parameter. The list of forms can
be found in customer_form_attribute table.

To modify the attribute, use \Magento\Customer\Setup\CustomerSetupFactory. We can also use updateAttribute method or load
the attribute using getAttribute method and modify the parameter via setData.
```php
$customerSetup = $this->customerSetupFactory->create(['setup' => $setup]);
$customerSetup->updateAttribute(\Magento\Customer\Model\Customer::ENTITY, 'new_attribute', 'visible', false);
````
```php
$customerSetup = $this->customerSetupFactory->create(['setup' => $setup]);
    $attribute = $customerSetup->getEavConfig()->getAttribute(
\Magento\Customer\Model\Customer::ENTITY, 
'new_attribute') 
->setData('used_in_forms', ['adminhtml_customer']);
$attribute->save();
````
## How would you extend the customer entity using the extension attributes mechanism?
Module developers can not modify API Data interfaces, described in core Magento 2, but the majority of the modules have 
the extension attributes mechanism. Extension attributes are set and stored separately from the data object of the initial
class, so everything, connected with data storage and extraction, must be realized by the developer himself.

To create extension attribute, declare it in the etc/extension_attribute.xml file of the module:
```php
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:Api/etc/extension_attributes.xsd"> 
<extension_attributes for="Magento\Customer\Api\Data\CustomerInterface"> 
<attribute code="new_attribute" type="string" /> 
</extension_attributes> 
</config>
````
To get or modify extension attributes, apply the system of plugins to save, get, getList methods for Product Repository.

Example of extension_attributes for Customer.

File etc/extension_attributes.xml:
```xml
<?xml version="1.0" encoding="utf-8" ?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:noNamespaceSchemaLocation="urn:magento:framework:Api/etc/extension_attributes.xsd">
    <extension_attributes for="Magento\Customer\Api\Data\CustomerInterface">
        <attribute code="ext_customer_attribute" type="string" />
    </extension_attributes>
    </config>
````
etc/di.xml
```xml
<?xml version="1.0"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <type name="Magento\Customer\Api\CustomerRepositoryInterface">
        <plugin name="extensionAttributeExtCustomerAttribute" type="Belvg\CustomExtAttribute\Model\Plugin\CustomerRepository" />
    </type>
</config>
````

Model/Plugin/CustomerRepository.php
```php
<?php
namespace Belvg\CustomExtAttribute\Model\Plugin\CustomerRepository;
...
class CustomerRepository
{
…
    public function afterGet(CustomerRepositoryInterface $subject, CustomerInterface $result)
    {
        $extensionAttributes = $this->getExtensionAttributes($result);
//custom logic
        $extCustomerAttribute = $this->customGetExtCustomerAttribute();
        $extensionAttributes->setExtCustomerAttribute($extCustomerAttribute)
        return $result;
    }

    public function aroundSave(
        CustomerRepositoryInterface $subject,
        callable $proceed,
        CustomerInterface $customer,
        $passwordHash = null
    ) {
            $extCustomerAttribute = $customer->getExtensionAttributes()->getExtCustomerAttribute(); 
            $result = $proceed($customer, $passwordHash);
	$this->customSetExtCustomerAttribute($extCustomerAttribute);
	return $result;
}
````
## Describe how to customize the customer address.
To add new fields into customer address, create an EAV attribute using \Magento\Customer\Setup\CustomerSetupFactory.
```php
$customerSetup->addAttribute(\Magento\Customer\Api\AddressMetadataInterface::ENTITY_TYPE_ADDRESS, 'custom_address_attribute', [
            'type' => 'varchar',
            'label' => 'Custom address attribute',
            'input' => 'text',
            'required' => false,
            'visible' => true,
            'user_defined' => true,
            'sort_order' => 100,
            'position' => 100,
            'system' => 0,
        ]);

        $customerEntity = $customerSetup->getEavConfig()->getEntityType(\Magento\Customer\Api\AddressMetadataInterface::ENTITY_TYPE_ADDRESS);
        $attributeSetId = $customerEntity->getDefaultAttributeSetId();

        $attributeSet = $this->attributeSetFactory->create();
        $attributeGroupId = $attributeSet->getDefaultGroupId($attributeSetId);

        $attribute = $customerSetup->getEavConfig()->getAttribute(\Magento\Customer\Api\AddressMetadataInterface::ENTITY_TYPE_ADDRESS,
            'district');
        $attribute->addData([
                'attribute_set_id' => $attributeSetId,
                'attribute_group_id' => $attributeGroupId,
                'used_in_forms' =>
                    [
                        'adminhtml_customer_address',
                        'customer_address_edit',
                        'customer_register_address',
                    ]
            ]
        );

        $attribute->save();
````

## Describe customer groups and their role in different business processes.

User groups allow to modify taxes and discounts, create separate price rules for different product groups, as well as 
separate their rights at the store side. Different product groups have different cache for blocks.

There are the following default user groups:
1. NOT LOGGED IN
2. General
3. Wholesale
4. Retailer

## Describe Magento functionality related to VAT.
Magento is a built-in functionality for working with VAT. VAT depends on seller’s country and buyer’s address. When a 
downloadable product is purchased, VAT depends solely on the delivery destination.

## How do you customize VAT functionality?
To configure VAT, you can navigate to the following path:
`Stores > Configuration > General > General > Store Information`

VAT Number – this is where you set the seller’s VAT number.

Customers > All Customers > Edit Customer

Account Information > Tax/VAT Number – if set, then VAT will be calculated based on the given field.

Addresses > VAT Number – if selected, VAT will be calculated with VAT taken into account.

Configure > Customers > Customer Configuration

Show VAT Number on Storefront – allows a customer to set VAT Number when the account is created or edited.

Default Value for Disable Automatic Group Changes Based on VAT ID – when selected, it automatically changes the user group 
after the VAT Number is validated.

The parameters you see at the screenshot below are responsible for group selection after the validation, if the “Default
Value for Disable Automatic Group Changes Based on VAT ID” parameter is active.

For the correct functioning of VAT in Magento, set the user groups and create the rules and rates for TAX.

Tax can be applied separately to products and users with Product Tax Classes and Customer Tax Classes (Stores > Tax Rules); 
you can also create taxes for certain areas with Tax Zones and Rates( Stores > Tax Zones and Rates).

To modify Tax, apply sales_quote_collect_totals_before event that calculates the order’s total cost.